var __awaiter=this&&this.__awaiter||function(e,o,t,r){return new(t||(t=Promise))((function(i,n){function l(e){try{a(r.next(e))}catch(e){n(e)}}function s(e){try{a(r.throw(e))}catch(e){n(e)}}function a(e){var o;e.done?i(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(l,s)}a((r=r.apply(e,o||[])).next())}))};define(["require","exports","./apis","./edgeCases"],(function(e,o,t,r){"use strict";function i(e,o){const t=[];for(const r of e.files)r.name.endsWith(".d.ts")&&t.push({moduleName:e.moduleName,moduleVersion:e.version,vfsPath:`${o}${r.name}`,path:r.name});return t}function n(e,t,i){return(0,o.getReferencesForModule)(e.typescript,i).map((e=>Object.assign(Object.assign({},e),{module:(0,r.mapModuleNameToModule)(e.module)}))).filter((e=>!e.module.startsWith("."))).filter((e=>!t.has(e.module)))}function l(e){return 0===e.indexOf("@")&&-1!==e.indexOf("/")&&(e=e.substr(1).replace("/","__")),e}Object.defineProperty(o,"__esModule",{value:!0}),o.getFileTreeForModuleWithTag=o.getNewDependencies=o.getReferencesForModule=o.setupTypeAcquisition=void 0,o.setupTypeAcquisition=e=>{const r=new Map,s=new Map;let a=0,d=0;return o=>{a=0,d=0,u(o,0).then((o=>{var t,r;d>0&&(null===(r=(t=e.delegate).finished)||void 0===r||r.call(t,s))}))};function u(c,f){var m,g,p,h,v;return __awaiter(this,void 0,void 0,(function*(){const y=n(e,r,c);y.forEach((e=>r.set(e.module,{state:"loading"})));const F=(yield Promise.all(y.map((t=>(0,o.getFileTreeForModuleWithTag)(e,t.module,t.version))))).filter((e=>!("error"in e))),M=F.filter((e=>e.files.find((e=>e.name.endsWith(".d.ts"))))),_=M.map((e=>i(e,`/node_modules/${e.moduleName}`))),N=F.filter((e=>!M.includes(e))),$=(yield Promise.all(N.map((t=>(0,o.getFileTreeForModuleWithTag)(e,`@types/${l(t.moduleName)}`,"latest"))))).filter((e=>!("error"in e))),w=$.map((e=>i(e,`/node_modules/@types/${l(e.moduleName).replace("types__","")}`))),T=_.concat(w).reduce(((e,o)=>e.concat(o)),[]);a+=T.length,T.length&&0===f&&(null===(g=(m=e.delegate).started)||void 0===g||g.call(m));for(const o of F){let r=`/node_modules/${o.moduleName}`;$.includes(o)&&(r=`/node_modules/@types/${l(o.moduleName).replace("types__","")}`);const i=r+"/package.json",n=yield(0,t.getDTSFileForModuleWithVersion)(e,o.moduleName,o.version,"/package.json");"string"==typeof n?(s.set(i,n),null===(h=(p=e.delegate).receivedFile)||void 0===h||h.call(p,n,i)):null===(v=e.logger)||void 0===v||v.error(`Could not download package.json for ${o.moduleName}`)}yield Promise.all(T.map((o=>__awaiter(this,void 0,void 0,(function*(){var r,i,n;const l=yield(0,t.getDTSFileForModuleWithVersion)(e,o.moduleName,o.moduleVersion,o.path);d++,l instanceof Error?null===(r=e.logger)||void 0===r||r.error(`Had an issue getting ${o.path} for ${o.moduleName}`):(s.set(o.vfsPath,l),null===(n=(i=e.delegate).receivedFile)||void 0===n||n.call(i,l,o.vfsPath),e.delegate.progress&&d%5==0&&e.delegate.progress(d,a),yield u(l,f+1))})))))}))}},o.getReferencesForModule=(e,o)=>{const t=e.preProcessFile(o),r=e.libMap||new Map;return t.referencedFiles.concat(t.importedFiles).concat(t.libReferenceDirectives).filter((e=>!e.fileName.endsWith(".d.ts"))).filter((e=>!r.has(e.fileName))).map((e=>{let t;if(!e.fileName.startsWith(".")){t="latest";const r=o.slice(e.end).split("\n")[0];r.includes("// types:")&&(t=r.split("// types: ")[1].trim())}return{module:e.fileName,version:t}}))},o.getNewDependencies=n,o.getFileTreeForModuleWithTag=(e,o,r)=>__awaiter(void 0,void 0,void 0,(function*(){let i=r||"latest";if(i.split(".").length<2){const n=yield(0,t.getNPMVersionForModuleReference)(e,o,i);if(n instanceof Error)return{error:n,userFacingMessage:`Could not go from a tag to version on npm for ${o} - possible typo?`};const l=n.version;if(!l){const i=yield(0,t.getNPMVersionsForModule)(e,o);if(i instanceof Error)return{error:n,userFacingMessage:`Could not get versions on npm for ${o} - possible typo?`};const l=Object.entries(i.tags).join(", ");return{error:new Error("Could not find tag for module"),userFacingMessage:`Could not find a tag for ${o} called ${r}. Did find ${l}`}}i=l}const n=yield(0,t.getFiletreeForModuleWithVersion)(e,o,i);return n instanceof Error?{error:n,userFacingMessage:`Could not get the files for ${o}@${i}. Is it possibly a typo?`}:n}))}));